---
- name: Install Kubernetes using k3s and k3sup
  hosts: localhost
  become: yes

  tasks:
    - name: Install dependencies
      apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      loop:
        - apt-transport-https
        - ca-certificates
        - curl
        - software-properties-common

    - name: Download k3sup
      get_url:
        url: https://github.com/alexellis/k3sup/releases/download/0.10.0/k3sup
        dest: /usr/local/bin/k3sup
        mode: '0755'

    - name: Install k3s on master node
      command: k3sup install --user {{ ansible_user }} --ip {{ ansible_default_ipv4.address }}

    - name: Configure kubectl
      shell: |
        mkdir -p ~/.kube
        cp kubeconfig ~/.kube/config
        export KUBECONFIG=~/.kube/config
        kubectl get nodes
      args:
        chdir: /root/.kube